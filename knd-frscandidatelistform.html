<link rel="import"
      href="../polymer/polymer.html"/>
<link rel="import"
      href="../core-ajax/core-ajax.html"/>

<link rel="import" href="../core-icons/core-icons.html">
<link rel="import" href="../core-icons/av-icons.html">
<link rel="import" href="../core-icons/maps-icons.html">
<link rel="import" href="../core-icons/image-icons.html">
<link rel="import" href="../core-icons/social-icons.html">
<link rel="import" href="../core-selector/core-selector.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">

<!-- @Todo clean import and bower.json file -->
<script src="../underscore/underscore.js"></script>
<script src="../underscore.string/lib/underscore.string.js"></script>
<!-- bootstrap actions -->
<link rel="stylesheet"
      href="../bootstrap/dist/css/bootstrap-theme.css"/>
<link rel="stylesheet"
      href="../bootstrap/dist/css/bootstrap.css"/>


<!--
@Todo collapse
Element providing solution to no problem in particular.

##### Example

    <knd-frscandidatelistform
     url=".."
          navmode=""

          skip=""
          limit=""
          params=""
          expandmax="50"
          displaystep="10"
          headers='{"X-Requested-With": "XMLHttpRequest"}'
    ></knd-loginform>
navmode define the way to navigate into the resultset via URL
 - URL_CALL will produce url = url+'/'{{skip}}+'/'{{limit}}
 - PARAMS_CALL will produce url = url+'?'&skip={{skip}}&limit={{limit}}
@element knd-frscandidatelistform
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://kanedafromparis.github.io/knd-frscandidatelistform

-->
<polymer-element name="knd-frscandidatelistform"
                 attributes="url navmode skip limit expandmax displaystep params editurl">

    <template>
        <section>
            <paper-icon-button icon="av:skip-previous" on-click="{{skipPrevious}}"></paper-icon-button>
            <paper-icon-button icon="av:fast-rewind" on-click="{{fastRewind}}"></paper-icon-button>
            <paper-icon-button icon="expand-less" on-click="{{expandLess}}"></paper-icon-button>
            <paper-icon-button icon="expand-more" on-click="{{expandMore}}"></paper-icon-button>
            <paper-icon-button icon="av:fast-forward" on-click="{{fastForward}}"></paper-icon-button>
            <paper-icon-button icon="av:skip-next" on-click="{{skipNext}}"></paper-icon-button>
        </section>

        <link rel="stylesheet"
              href="knd-frscandidatelistform.css"/>
        <core-ajax
                id="userDataSource"
                auto="false"
                url="{{computedURL}}"
                params="{{params}}"
                handleAs="json"
                on-core-response="{{handleResponse}}"></core-ajax>
        <table class="table table-striped">
            <thead>
            <tr>
                <th>#</th>
                <th>Last Name</th>
                <th>First Name</th>
                <th>Email</th>
                <th>Birth Date</th>
                <th>Birth Country</th>
                <th>Education</th>
                <th>Picture</th>
            </tr>
            </thead>
            <tbody>
            <template id="userTable" repeat="{{user in users}}">
                <tr>
                    <td><a href="{{editurl+user._id.$oid}}">{{user._id.$oid}}</a></td>
                    <td>{{user.main.lastname}}</td>
                    <td>{{user.main.firstname}}</td>
                    <td>
                        <template id="emails" repeat="{{email in user.emails}}">
                            <div>{{email}}</div>
                        </template>

                    </td>
                    <td>{{formatDate(user.main.birthDate.$date)}}</td>
                    <td>{{user.main.birthCountry}}</td>
                    <td>{{user.main.education}}</td>
                    <td>{{user.picturesStatus}}</td>
                </tr>
            </template>
            </tbody>
        </table>

        <!-- navigation bar -->

        <section>
            <paper-icon-button icon="av:skip-previous" on-click="{{skipPrevious}}"></paper-icon-button>
            <paper-icon-button icon="av:fast-rewind" on-click="{{fastRewind}}"></paper-icon-button>
            <paper-icon-button icon="expand-less" on-click="{{expandLess}}"></paper-icon-button>
            <paper-icon-button icon="expand-more" on-click="{{expandMore}}"></paper-icon-button>
            <paper-icon-button icon="av:fast-forward" on-click="{{fastForward}}"></paper-icon-button>
            <paper-icon-button icon="av:skip-next" on-click="{{skipNext}}"></paper-icon-button>
        </section>

    </template>

    <script>
        _.mixin(_.str.exports());
        Polymer('knd-frscandidatelistform', {
            publish: {
                url: null,
                computedURL: null,
                params: {},
                users: [],
                skip: 0,
                limit: 10,
                end: 0,
                expandmax: 50,
                displaystep:10,
                navmode:"URL_CALL",
                observe: {
                    url: 'validate'
                }

            },
            ready: function () {
                this.updateTable();
            },
            updateTable: function () {
                this.buildRequest();
                this.$.userDataSource.go();
            },
            handleResponse: function (e) {
                console.log("handleResponse : " + JSON.stringify(e.detail.response));
                this.users = e.detail.response.users;
                if (this.expandmax > e.detail.response.expandmax){
                    this.expandmax = e.detail.response.expandmax;
                }
                this.end = e.detail.response.end;


            },

            validate: function (oldValue, newValue) {
                /**
                 * Should refresh the list
                 */
                //console.log("validate : " + JSON.stringify(oldValue) + " - " + JSON.stringify(newValue));
            },
            formatDate: function (dateValue) {
                /**
                 * Should refresh the list
                 */
                console.log("formatDate : " + JSON.stringify(dateValue));
                return _.truncate(dateValue, 10);
            },
            skipPrevious: function () {
                this.skip=0;
                this.updateTable();
            },
            fastRewind: function (dateValue) {
                this.skip=this.skip-this.limit;
                if (this.skip < this.limit){
                    this.skip=0;
                }
                this.updateTable();
            },
            fastForward: function (dateValue) {
                this.skip=this.skip+this.limit;
                if (this.skip > this.end){
                    this.skip=this.end-this.limit;
                }
                this.updateTable();
            },
            skipNext: function (dateValue) {
                this.skip=this.end-this.limit;
            this.updateTable();
        },
            expandLess: function (dateValue) {
                this.limit = this.limit - this.displaystep;
                if(this.limit<this.displaystep){
                    this.limit = this.displaystep;
                }
            this.updateTable();
        },
            expandMore: function (dateValue) {
                this.limit = this.limit + this.displaystep;
                if(this.limit>this.expandmax){
                    this.limit = this.expandmax;
                }
            this.updateTable();
        },

            buildRequest: function () {
                if (typeof this.url == "undefined") {
                    console.error("typeof this.url == \"undefined\")");
                }
                    if(this.navmode=='URL_CALL'){
                        this.computedURL = this.url+'/'+this.skip+'/'+this.limit;
                    }
                    if(this.navmode=='PARAMS_CALL'){
                        this.computedURL = this.url;
                        this.params['skip']=this.skip;
                        this.params['limit']=this.limit;
                    }

            }
        });

    </script>

</polymer-element>
<script src="../jquery/dist/jquery.js"></script>
<script src="../bootstrap/dist/js/bootstrap.js"></script>